// ==UserScript==
// @name         Admin Enhancements
// @namespace    admin
// @version      0.4.1
// @description  Chris's Admin Enhancements
// @author       Chris Pittelko
// @match        https://admin.ring.com/*
// @require      http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js
// @require      https://gist.github.com/raw/2625891/waitForKeyElements.js
// @grant        GM_addStyle
// @updateURL    https://raw.githubusercontent.com/EpicChloe/AdminEnhancements/master/AdminEnhancements.user
// ==/UserScript==

/* Change Log
v0.4.1
Changed placeholder to button. Not functional at the moment.
v0.4
Converted to using jNode checks. Should only be checking the node that was changed instead of the entire document.
v0.3.2
Fixed MSP Error not highlighting when blank
v0.3.1
Fixed MSP Errors not highlighting
v0.3
Added update URL
v0.2
Added Low Battery Warning (<15%)
Changed Update Method to look for Ajax changes instead of Pulse Method
*/

// Color Guide:
// Red: MSP430 Error
// Orange: Low Battery (<15%)
// Blue: OTA/Setup
// Yellow: RSSI < -70

function highlightReports (jNode) {

    var rssiValue = jNode.find('.key.ng-binding:contains("rssi")').parent().find(':nth-child(2)').html(),
        batteryValue = jNode.find('.key.ng-binding:contains("battery_percentage")').parent().find(':nth-child(2)').html(),
        mspValue = jNode.find('.key.ng-binding:contains("msp430_error")').parent().find(':nth-child(2)').html(); 
    
    if (rssiValue <= -70 && rssiValue !== null) {
        jNode.css("background-color", "#fcf8e3");
    }
    
    if (batteryValue <= 15 && batteryValue !== null) {
        jNode.css("background-color", "#ffc370");
    }
    
    jNode.find('.context.ng-binding:contains("After OTA")').parent().css("background-color", "#d9edf7");
    
    jNode.find('.context.ng-binding:contains("After Setup")').parent().css("background-color", "#d9edf7");
    
    if (mspValue != 0 && mspValue !== null) {
        jNode.css("background-color", "#f2dede");
    }
    
    jNode.find('.status_date.ng-binding').append('<a class="btn btn-xs btn-primary APESummaryButton">Summary<span>Summary Tooltip!</span></a>');

};

waitForKeyElements ("tr.ng-scope", highlightReports);

GM_addStyle('a.APESummaryButton {position: relative;display: inline; !important}');
GM_addStyle('a.APESummaryButton span {position: absolute; width:140px; color: #FFFFFF; background: #000000; height: 30px; line-height: 30px; text-align: center; visibility: hidden; border-radius: 6px; !important}');
//GM_addStyle('a.APESummaryButton span:after{content:'';position:absolute;top:50%;right:100%;margin-top:-8px;width:0;height:0;border-right:8px solid #000;border-top:8px solid transparent;border-bottom:8px solid transparent !important}');
GM_addStyle('a:hover.APESummaryButton span {visibility: visible; opacity: 0.8; left: 100%; top: 50%; margin-top: -15px; margin-left: 15px; z-index: 999; !important}');

console.log($('.panel-heading').find(':contains("Reports Summary")').html());

$( document ).ready(function() {
    setTimeout(function () {
        console.log($('.panel-heading').find(':contains("Reports Summary")').append('<a class="btn pull-right btn-primary text-center vcenter">Generate Battery Graph</a>'));
    }, 2000);
});

GM_addStyle('.panel-heading {height: 38px; padding: 0px; !important}');
